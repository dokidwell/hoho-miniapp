{{ define "content" }}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">用户管理</h1>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <form class="d-flex" method="GET" action="/admin/users">
            <input class="form-control me-2" type="search" placeholder="搜索UID或手机号" aria-label="Search" name="search" value="{{ .Search }}">
            <button class="btn btn-outline-primary" type="submit">搜索</button>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>ID</th>
                <th>UID</th>
                <th>手机号</th>
                <th>昵称</th>
                <th>实名认证</th>
                <th>状态</th>
                <th>注册时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {{ range .Users }}
            <tr>
                <td>{{ .ID }}</td>
                <td>{{ .UID }}</td>
                <td>{{ .Phone }}</td>
                <td>{{ .Nickname }}</td>
                <td>
                    {{ if .IdentityVerified }}
                        <span class="badge bg-success">已认证</span>
                    {{ else }}
                        <span class="badge bg-warning text-dark">未认证</span>
                    {{ end }}
                </td>
                <td>
                    {{ if eq .Status "active" }}
                        <span class="badge bg-primary">活跃</span>
                    {{ else if eq .Status "suspended" }}
                        <span class="badge bg-danger">禁用</span>
                    {{ else }}
                        <span class="badge bg-secondary">{{ .Status }}</span>
                    {{ end }}
                </td>
                <td>{{ .CreatedAt.Format "2006-01-02 15:04" }}</td>
                <td>
                    <a href="/admin/users/{{ .ID }}" class="btn btn-sm btn-info">详情</a>
                    {{ if eq .Status "active" }}
                        <button class="btn btn-sm btn-danger" onclick="updateUserStatus({{ .ID }}, 'suspended')">禁用</button>
                    {{ else }}
                        <button class="btn btn-sm btn-success" onclick="updateUserStatus({{ .ID }}, 'active')">解禁</button>
                    {{ end }}
                </td>
            </tr>
            {{ else }}
            <tr>
                <td colspan="8" class="text-center">没有找到用户</td>
            </tr>
            {{ end }}
        </tbody>
    </table>
</div>

<!-- 分页 -->
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {{ if gt .Page 1 }}
        <li class="page-item">
            <a class="page-link" href="/admin/users?page={{ sub .Page 1 }}&search={{ .Search }}">上一页</a>
        </li>
        {{ end }}

        {{ range $i := .Pages }}
        <li class="page-item {{ if eq $i $.Page }}active{{ end }}">
            <a class="page-link" href="/admin/users?page={{ $i }}&search={{ $.Search }}">{{ $i }}</a>
        </li>
        {{ end }}

        {{ if lt .Page .TotalPages }}
        <li class="page-item">
            <a class="page-link" href="/admin/users?page={{ add .Page 1 }}&search={{ .Search }}">下一页</a>
        </li>
        {{ end }}
    </ul>
</nav>

<script>
    function updateUserStatus(userID, status) {
        if (!confirm(`确定要将用户 ${userID} 的状态更改为 ${status === 'active' ? '活跃' : '禁用'} 吗？`)) {
            return;
        }

        const token = localStorage.getItem('admin_token');
        fetch(`/admin/users/${userID}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.code === 0) {
                alert('操作成功');
                window.location.reload();
            } else {
                alert('操作失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('网络错误，操作失败');
        });
    }
</script>
{{ end }}
