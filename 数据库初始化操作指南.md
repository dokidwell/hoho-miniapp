# ğŸ“Š æ•°æ®åº“åˆå§‹åŒ–æ“ä½œæŒ‡å—

## âš ï¸ é‡è¦æç¤º

**æ•°æ®åº“è¡¨è¿˜æœªåœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šåˆ›å»ºï¼** è¿™æ˜¯å½“å‰æœ€é‡è¦çš„å¾…åŠäº‹é¡¹ã€‚

---

## ğŸš€ å¿«é€Ÿåˆå§‹åŒ–ï¼ˆæ¨èï¼‰

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬

æˆ‘å·²ç»åˆ›å»ºäº†ä¸€ä¸ªå…¨è‡ªåŠ¨çš„åˆå§‹åŒ–è„šæœ¬ `setup_database.sh`ï¼Œå®ƒä¼šï¼š

1. âœ… æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€
2. âœ… åˆ›å»º/éªŒè¯æ•°æ®åº“
3. âœ… æ‰§è¡ŒSQLåˆå§‹åŒ–è„šæœ¬
4. âœ… åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·
5. âœ… é‡å¯åç«¯æœåŠ¡
6. âœ… æµ‹è¯•APIè¿æ¥

**æ‰§è¡Œæ­¥éª¤**ï¼š

```bash
# 1. SSHç™»å½•æœåŠ¡å™¨ï¼ˆä½¿ç”¨SSHå¯†é’¥ï¼‰
ssh ubuntu@119.45.242.49

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/hoho-miniapp/backend

# 3. ä»GitHubæ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 4. ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x setup_database.sh

# 5. è¿è¡Œåˆå§‹åŒ–è„šæœ¬
./setup_database.sh
```

**é¢„æœŸè¾“å‡º**ï¼š

```
==========================================
HOHOå°ç¨‹åºæ•°æ®åº“åˆå§‹åŒ–
==========================================

1. æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€...
âœ“ MySQLæœåŠ¡æ­£åœ¨è¿è¡Œ

2. æ£€æŸ¥æ•°æ®åº“...
âœ“ æ•°æ®åº“ hoho_miniapp å·²å­˜åœ¨

3. æ£€æŸ¥æ•°æ®åº“è¡¨...
âœ“ æ•°æ®åº“ä¸ºç©ºï¼Œå‡†å¤‡åˆ›å»ºè¡¨

4. æ‰§è¡ŒSQLåˆå§‹åŒ–è„šæœ¬...
âœ“ SQLè„šæœ¬æ‰§è¡ŒæˆåŠŸ

5. éªŒè¯è¡¨åˆ›å»º...
âœ“ æˆåŠŸåˆ›å»º 12 ä¸ªè¡¨ï¼š
  - users
  - user_points
  - point_transactions
  - collections
  - assets
  - asset_instances
  - listings
  - trades
  - third_party_accounts
  - jingtan_assets
  - community_events
  - admins

6. åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·...
âœ“ å¯†ç å“ˆå¸Œç”ŸæˆæˆåŠŸ
âœ“ ç®¡ç†å‘˜è´¦æˆ·åˆ›å»ºæˆåŠŸ

7. ç®¡ç†å‘˜è´¦æˆ·ä¿¡æ¯
+----+----------+----------------------+-------------+--------+---------------------+
| id | username | email                | role        | status | created_at          |
+----+----------+----------------------+-------------+--------+---------------------+
|  1 | admin    | admin@hohopark.com   | super_admin | active | 2024-11-19 12:00:00 |
+----+----------+----------------------+-------------+--------+---------------------+

ç®¡ç†å‘˜ç™»å½•ä¿¡æ¯ï¼š
  ç”¨æˆ·å: admin
  å¯†ç : Admin@123456
  ç™»å½•åœ°å€: https://api.hohopark.com/admin/login

8. é‡å¯åç«¯æœåŠ¡...
âœ“ åç«¯æœåŠ¡å·²é‡å¯

9. æµ‹è¯•APIè¿æ¥...
âœ“ APIè¿æ¥æ­£å¸¸
  å¥åº·æ£€æŸ¥: https://api.hohopark.com/health

==========================================
æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼
==========================================
```

---

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨æ‰§è¡ŒSQL

å¦‚æœè‡ªåŠ¨åŒ–è„šæœ¬é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
# 1. SSHç™»å½•æœåŠ¡å™¨
ssh ubuntu@119.45.242.49

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/hoho-miniapp/backend

# 3. æ‰§è¡ŒSQLè„šæœ¬
sudo mysql hoho_miniapp < init.sql

# 4. éªŒè¯è¡¨åˆ›å»º
sudo mysql hoho_miniapp -e "SHOW TABLES;"

# 5. åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·ï¼ˆéœ€è¦Pythonï¼‰
python3 << 'EOF'
import bcrypt
import mysql.connector

# ç”Ÿæˆå¯†ç å“ˆå¸Œ
password = "Admin@123456".encode('utf-8')
hashed = bcrypt.hashpw(password, bcrypt.gensalt()).decode('utf-8')

# è¿æ¥æ•°æ®åº“
conn = mysql.connector.connect(
    host="localhost",
    user="hoho",
    password="HoHo@2024!Secure",
    database="hoho_miniapp"
)

cursor = conn.cursor()

# æ’å…¥ç®¡ç†å‘˜
cursor.execute("""
    INSERT INTO admins (username, password_hash, email, role, status, created_at, updated_at)
    VALUES (%s, %s, %s, %s, %s, NOW(), NOW())
""", ('admin', hashed, 'admin@hohopark.com', 'super_admin', 'active'))

conn.commit()
print("âœ… ç®¡ç†å‘˜è´¦æˆ·åˆ›å»ºæˆåŠŸ")
print(f"ç”¨æˆ·å: admin")
print(f"å¯†ç : Admin@123456")

cursor.close()
conn.close()
EOF

# 6. é‡å¯åç«¯æœåŠ¡
sudo systemctl restart hoho-api

# 7. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status hoho-api
```

---

### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨GORMè‡ªåŠ¨è¿ç§»

```bash
# 1. SSHç™»å½•æœåŠ¡å™¨
ssh ubuntu@119.45.242.49

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/hoho-miniapp/backend

# 3. åˆ›å»ºè¿ç§»è„šæœ¬
cat > migrate.go << 'EOF'
package main

import (
	"fmt"
	"log"
	"os"
	
	"github.com/joho/godotenv"
	"gorm.io/driver/mysql"
	"gorm.io/gorm"
)

// ç®€åŒ–çš„æ¨¡å‹å®šä¹‰
type User struct {
	gorm.Model
	UID              string `gorm:"type:varchar(20);uniqueIndex"`
	Phone            string `gorm:"type:varchar(20);uniqueIndex"`
	PasswordHash     string
	Nickname         string
	AvatarURL        string
	RealName         string
	IDNumber         string
	IdentityVerified bool
	Status           string
}

type UserPoint struct {
	gorm.Model
	UserID      uint64 `gorm:"uniqueIndex"`
	Balance     string `gorm:"type:decimal(30,8)"`
	Frozen      string `gorm:"type:decimal(30,8)"`
	TotalEarned string `gorm:"type:decimal(30,8)"`
	TotalSpent  string `gorm:"type:decimal(30,8)"`
}

type PointTransaction struct {
	gorm.Model
	UserID      uint64 `gorm:"index"`
	Type        string
	Amount      string `gorm:"type:decimal(30,8)"`
	Description string
	RelatedID   uint64
	RelatedType string
}

type Collection struct {
	gorm.Model
	Name        string
	Description string
	CoverImage  string
	Status      string
}

type Asset struct {
	gorm.Model
	CollectionID uint64 `gorm:"index"`
	Name         string
	Description  string
	MediaURL     string
	MediaType    string
	TotalSupply  int
	MintedCount  int
	CreatorID    uint64
	Status       string
}

type AssetInstance struct {
	gorm.Model
	AssetID    uint64 `gorm:"index"`
	InstanceNo string
	OwnerID    uint64 `gorm:"index"`
	TokenID    string
	Status     string
}

type Listing struct {
	gorm.Model
	AssetInstanceID uint64 `gorm:"index"`
	SellerID        uint64 `gorm:"index"`
	Price           string `gorm:"type:decimal(30,8)"`
	Status          string
	ExpiresAt       *gorm.DeletedAt
}

type Trade struct {
	gorm.Model
	ListingID       uint64 `gorm:"index"`
	AssetInstanceID uint64
	SellerID        uint64
	BuyerID         uint64
	Price           string `gorm:"type:decimal(30,8)"`
	Status          string
}

type ThirdPartyAccount struct {
	gorm.Model
	UserID           uint64 `gorm:"index"`
	Platform         string
	PlatformUID      string
	PlatformUsername string
	AccessToken      string
	RefreshToken     string
	TokenExpiresAt   *gorm.DeletedAt
}

type JingtanAsset struct {
	gorm.Model
	UserID         uint64 `gorm:"index"`
	JingtanAssetID string
	Name           string
	ImageURL       string
	Status         string
}

type CommunityEvent struct {
	gorm.Model
	EventType   string `gorm:"index"`
	Title       string
	Description string
	UserID      uint64
	RelatedID   uint64
	RelatedType string
}

type Admin struct {
	gorm.Model
	Username     string `gorm:"uniqueIndex"`
	PasswordHash string
	Email        string
	Role         string
	Status       string
	LastLoginAt  *gorm.DeletedAt
}

func main() {
	// åŠ è½½ç¯å¢ƒå˜é‡
	if err := godotenv.Load(".env"); err != nil {
		log.Println("æœªæ‰¾åˆ°.envæ–‡ä»¶ï¼Œä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡")
	}

	// æ„å»ºDSN
	dbHost := os.Getenv("DB_HOST")
	dbPort := os.Getenv("DB_PORT")
	dbUser := os.Getenv("DB_USER")
	dbPassword := os.Getenv("DB_PASSWORD")
	dbName := os.Getenv("DB_NAME")

	dsn := fmt.Sprintf("%s:%s@tcp(%s:%s)/%s?charset=utf8mb4&parseTime=True&loc=Local",
		dbUser, dbPassword, dbHost, dbPort, dbName)

	// è¿æ¥æ•°æ®åº“
	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
	if err != nil {
		log.Fatal("è¿æ¥æ•°æ®åº“å¤±è´¥:", err)
	}

	fmt.Println("å¼€å§‹æ•°æ®åº“è¿ç§»...")

	// è‡ªåŠ¨è¿ç§»
	err = db.AutoMigrate(
		&User{},
		&UserPoint{},
		&PointTransaction{},
		&Collection{},
		&Asset{},
		&AssetInstance{},
		&Listing{},
		&Trade{},
		&ThirdPartyAccount{},
		&JingtanAsset{},
		&CommunityEvent{},
		&Admin{},
	)

	if err != nil {
		log.Fatal("æ•°æ®åº“è¿ç§»å¤±è´¥:", err)
	}

	fmt.Println("âœ… æ•°æ®åº“è¿ç§»æˆåŠŸï¼")
}
EOF

# 4. è¿è¡Œè¿ç§»
export GOPROXY=https://goproxy.cn,direct
go run migrate.go

# 5. åˆ é™¤è¿ç§»è„šæœ¬
rm migrate.go

# 6. é‡å¯æœåŠ¡
sudo systemctl restart hoho-api
```

---

## âœ… éªŒè¯åˆå§‹åŒ–ç»“æœ

### 1. æ£€æŸ¥æ•°æ®åº“è¡¨

```bash
sudo mysql hoho_miniapp -e "SHOW TABLES;"
```

é¢„æœŸè¾“å‡ºï¼š
```
+---------------------------+
| Tables_in_hoho_miniapp    |
+---------------------------+
| admins                    |
| asset_instances           |
| assets                    |
| collections               |
| community_events          |
| jingtan_assets            |
| listings                  |
| point_transactions        |
| third_party_accounts      |
| trades                    |
| user_points               |
| users                     |
+---------------------------+
```

### 2. æ£€æŸ¥ç®¡ç†å‘˜è´¦æˆ·

```bash
sudo mysql hoho_miniapp -e "SELECT id, username, email, role, status FROM admins;"
```

### 3. æµ‹è¯•APIæ¥å£

```bash
# å¥åº·æ£€æŸ¥
curl https://api.hohopark.com/health

# è—å“åˆ—è¡¨
curl https://api.hohopark.com/api/v1/assets

# ç®¡ç†å‘˜ç™»å½•
curl -X POST https://api.hohopark.com/admin/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "Admin@123456"
  }'
```

### 4. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# åç«¯æœåŠ¡çŠ¶æ€
sudo systemctl status hoho-api

# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
sudo journalctl -u hoho-api -n 50

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u hoho-api -f
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### é—®é¢˜1ï¼šPython bcryptæ¨¡å—æœªå®‰è£…

```bash
# å®‰è£…bcrypt
sudo pip3 install bcrypt mysql-connector-python
```

### é—®é¢˜2ï¼šMySQLè¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥MySQLçŠ¶æ€
sudo systemctl status mysql

# æ£€æŸ¥å¯†ç 
sudo mysql -u hoho -p hoho_miniapp
# è¾“å…¥å¯†ç ï¼šHoHo@2024!Secure
```

### é—®é¢˜3ï¼šè¡¨å·²å­˜åœ¨

```bash
# åˆ é™¤æ‰€æœ‰è¡¨ï¼ˆå±é™©ï¼ä¼šä¸¢å¤±æ•°æ®ï¼‰
sudo mysql hoho_miniapp << 'EOF'
SET FOREIGN_KEY_CHECKS = 0;
DROP TABLE IF EXISTS users, user_points, point_transactions, collections, 
                     assets, asset_instances, listings, trades, 
                     third_party_accounts, jingtan_assets, community_events, admins;
SET FOREIGN_KEY_CHECKS = 1;
EOF

# é‡æ–°è¿è¡Œåˆå§‹åŒ–
./setup_database.sh
```

### é—®é¢˜4ï¼šåç«¯æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
sudo journalctl -u hoho-api -n 100 --no-pager

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat /opt/hoho-miniapp/backend/.env

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
cd /opt/hoho-miniapp/backend
./hoho-api
```

---

## ğŸ“‹ åˆå§‹åŒ–åçš„æ•°æ®åº“çŠ¶æ€

### è¡¨ç»“æ„

| è¡¨å | ç”¨é€” | è¡Œæ•° |
|-----|------|------|
| users | ç”¨æˆ·è¡¨ | 0 |
| user_points | ç”¨æˆ·ç§¯åˆ†è¡¨ | 0 |
| point_transactions | ç§¯åˆ†äº¤æ˜“è®°å½• | 0 |
| collections | è—å“é›†åˆ | 0 |
| assets | è—å“ | 0 |
| asset_instances | è—å“å®ä¾‹ | 0 |
| listings | äº¤æ˜“æŒ‚å• | 0 |
| trades | äº¤æ˜“è®°å½• | 0 |
| third_party_accounts | ç¬¬ä¸‰æ–¹è´¦æˆ· | 0 |
| jingtan_assets | é²¸æ¢èµ„äº§ | 0 |
| community_events | ç¤¾åŒºäº‹ä»¶ | 0 |
| admins | ç®¡ç†å‘˜ | 1 |

### é»˜è®¤ç®¡ç†å‘˜

- **ç”¨æˆ·å**ï¼šadmin
- **å¯†ç **ï¼šAdmin@123456
- **é‚®ç®±**ï¼šadmin@hohopark.com
- **è§’è‰²**ï¼šsuper_admin
- **çŠ¶æ€**ï¼šactive

---

## ğŸ¯ ä¸‹ä¸€æ­¥

åˆå§‹åŒ–å®Œæˆåï¼š

1. âœ… æµ‹è¯•ç®¡ç†å‘˜ç™»å½•
2. âœ… æµ‹è¯•APIæ¥å£
3. âœ… åˆ›å»ºæµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼‰
4. âœ… ç¼–è¯‘å‰ç«¯å°ç¨‹åº
5. âœ… æäº¤å¾®ä¿¡å®¡æ ¸

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹æ—¥å¿—ï¼š`sudo journalctl -u hoho-api -f`
2. æ£€æŸ¥æ•°æ®åº“ï¼š`sudo mysql hoho_miniapp -e "SHOW TABLES;"`
3. æµ‹è¯•APIï¼š`curl https://api.hohopark.com/api/v1/assets`
4. æŸ¥çœ‹GitHubï¼šhttps://github.com/dokidwell/hoho-miniapp

---

**ç¥åˆå§‹åŒ–é¡ºåˆ©ï¼** ğŸš€
